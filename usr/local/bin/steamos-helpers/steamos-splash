#!/bin/bash
set -uo pipefail

# --- 1. CONFIGURAZIONE & FALLBACK ---
GLOBAL_CONF="/etc/default/steamos-diy"
[ -f "$GLOBAL_CONF" ] && source "$GLOBAL_CONF"

SYSTEM_NAME="${SYSTEM_NAME:-SteamOS-DIY}"
DELAY_SHORT="${SPLASH_DELAY_SHORT:-1.0}"
DELAY_LONG="${SPLASH_DELAY_LONG:-2.5}"
LOCK_FILE="/run/steamos-splash.pid" # Usiamo /run che è in RAM (sparisce al reboot)

# --- 2. GESTIONE DETERMINISTICA DEL LOCK ---
if [[ -f "$LOCK_FILE" ]]; then
    OLD_PID=$(cat "$LOCK_FILE")
    if kill -0 "$OLD_PID" 2>/dev/null; then
        exit 0 # Un'altra istanza è già attiva, esci silenziosamente
    fi
fi
echo $$ > "$LOCK_FILE" # Scriviamo il nostro PID

# --- 3. FORZATURA TTY & RESET ---
# Forza il passaggio alla TTY1 e pulisce tutto
/usr/bin/chvt 1 2>/dev/null || true
echo -ne "\033c" > /dev/tty1
setterm -cursor off > /dev/tty1 || true

tty_out() {
    echo -ne "$1" > /dev/tty1
}

# --- 4. LOGICA DEGLI STATI ---
CYAN='\e[1;36m'; GREEN='\e[1;32m'; RED='\e[1;31m'; YELLOW='\e[1;33m'
WHITE='\e[1;37m'; GRAY='\e[1;30m'; RESET='\e[0m'
PAD="            "

MODE_ARG="${1:-auto}"

case "$MODE_ARG" in
    "game")     COLOR=$GREEN;  MODE="Game Mode";    STAT="Launching..."; DELAY=$DELAY_SHORT ;;
    "desktop")  COLOR=$CYAN;   MODE="Desktop Mode"; STAT="Switching..."; DELAY=$DELAY_SHORT ;;
    *)
        # Auto-rilevamento deterministico via Systemd
        if systemctl list-jobs | grep -q "reboot.target"; then
            COLOR=$YELLOW; MODE="System"; STAT="Rebooting..."; DELAY=$DELAY_LONG
        elif systemctl list-jobs | grep -qE "shutdown.target|poweroff.target|halt.target"; then
            COLOR=$RED;    MODE="System"; STAT="Shutting down..."; DELAY=$DELAY_LONG
        else
            COLOR=$WHITE;  MODE="Wait";   STAT="Processing..."; DELAY=$DELAY_SHORT
        fi
        ;;
esac

# --- 5. RENDERING ---
OUT="\n\n\n\n\n\n"
OUT+="${PAD}${COLOR}      ◢◤  ◢◤      ${RESET}   ${WHITE}${STEAMOS_USER:-user}${RESET}@${WHITE}${SYSTEM_NAME}${RESET}\n"
OUT+="${PAD}${COLOR}    ◢◤      ◢◤    ${RESET}   ${GRAY}-------------------${RESET}\n"
OUT+="${PAD}${COLOR}  ◢◤          ◢◤  ${RESET}   ${WHITE}OS    : ${SYSTEM_NAME}\n"
OUT+="${PAD}${COLOR}    ◢◤      ◢◤    ${RESET}   ${WHITE}Mode  : ${COLOR}${MODE}${RESET}\n"
OUT+="${PAD}${COLOR}      ◢◤  ◢◤      ${RESET}   ${WHITE}Status: ${GRAY}${STAT}${RESET}\n"

tty_out "$OUT"
sleep "${DELAY}"

# Pulizia finale
rm -f "$LOCK_FILE"
