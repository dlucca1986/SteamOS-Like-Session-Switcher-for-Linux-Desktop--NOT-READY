#!/bin/bash
# ==============================================================================
# SteamOS-DIY Boot Splash System
# Version: 3.1.0
# Description: Minimalist TTY1 splash screen for session transitions.
# Repository: https://github.com/dlucca1986/SteamMachine-DIY
# Path:        /usr/local/bin/steamos-helpers/steamos-splash
# License: MIT
# ==============================================================================

# --- Configuration & Environment ---
GLOBAL_CONF="/etc/default/steamos-diy"
[ -f "$GLOBAL_CONF" ] && source "$GLOBAL_CONF"

# Default fallback values
DISPLAY_USER="${STEAMOS_USER:-User}"
LOCK_FILE="/tmp/steamos-splash.lock"

# --- TTY Initialization ---
# Redirect output to physical console TTY1
exec > /dev/tty1 2>&1
# Hardware reset to clear previous frame buffers (prevents ghosting)
echo -ne '\033c'
# Hide terminal cursor for a cleaner look
setterm -cursor off

# --- UI Color Definitions (ANSI) ---
CYAN='\e[1;36m'    # Desktop Mode
GREEN='\e[1;32m'   # Game Mode
RED='\e[1;31m'     # Shutdown
YELLOW='\e[1;33m'  # Reboot
WHITE='\e[1;37m'   # Primary Text
GRAY='\e[1;30m'    # Subtitles/Separator
RESET='\e[0m'      # Reset Formatting

# Visual padding for ASCII art alignment
PAD="            "

# --- Argument & State Logic ---
case "$1" in
    "game")
        # Session Start: Gaming Mode
        rm -f "$LOCK_FILE" 2>/dev/null || true
        COLOR=$GREEN; MODE="Game Mode"; STAT="Active"; DELAY=0.8
        ;;
    "desktop")
        # Session Start: Desktop Mode
        rm -f "$LOCK_FILE" 2>/dev/null || true
        COLOR=$CYAN; MODE="Desktop Mode"; STAT="Online"; DELAY=0.8
        ;;
    "reboot")
        # System State: Rebooting
        COLOR=$YELLOW; MODE="System"; STAT="Rebooting..."; DELAY=1.0
        ;;
    "shutdown")
        # System State: Powering Off
        COLOR=$RED; MODE="System"; STAT="Shutting down..."; DELAY=1.0
        ;;
    *)
        # Auto-Detection Logic for Generic Calls (e.g., systemd ExecStopPost)
        if systemctl list-jobs | grep -q "reboot.target"; then
            COLOR=$YELLOW; MODE="System"; STAT="Rebooting..."; DELAY=2.5
        elif systemctl list-jobs | grep -qE "shutdown.target|poweroff.target|halt.target"; then
            COLOR=$RED; MODE="System"; STAT="Shutting down..."; DELAY=2.5
        else
            # Exit if session is already active or locked to prevent flicker
            [[ -f "$LOCK_FILE" ]] && exit 0
            COLOR=$WHITE; MODE="Wait"; STAT="Processing..."; DELAY=0.5
        fi
        ;;
esac

# --- Screen Rendering ---
# Vertical offset for center-like positioning
echo -e "\n\n\n\n\n\n"

# Logo and System Info
echo -e "${PAD}${COLOR}      ◢◤  ◢◤      ${RESET}   ${WHITE}${DISPLAY_USER}${RESET}@${WHITE}steamos-diy${RESET}"
echo -e "${PAD}${COLOR}    ◢◤      ◢◤    ${RESET}   ${GRAY}-------------------${RESET}"
echo -e "${PAD}${COLOR}  ◢◤          ◢◤  ${RESET}   ${WHITE}Os     : SteamOS-DIY"
echo -e "${PAD}${COLOR}    ◢◤      ◢◤    ${RESET}   ${WHITE}Mode   : ${COLOR}${MODE}${RESET}"
echo -e "${PAD}${COLOR}      ◢◤  ◢◤      ${RESET}   ${WHITE}Status : ${GRAY}${STAT}${RESET}"

# Hold the splash for the defined duration
sleep $DELAY

# Restore cursor before exit (optional, but good practice)
setterm -cursor on
