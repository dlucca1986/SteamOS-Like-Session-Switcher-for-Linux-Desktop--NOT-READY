#!/bin/bash
# =============================================================================
# SteamOS-DIY - System Splash (v4.2.0)
# =============================================================================
set -uo pipefail

# --- 1. CARICAMENTO CONFIGURAZIONE MASTER ---
GLOBAL_CONF="/etc/default/steamos-diy"
if [[ -f "$GLOBAL_CONF" ]]; then
    source "$GLOBAL_CONF"
else
    exit 1
fi

# Fallback in caso le variabili non siano nel Master Config
SYSTEM_NAME="${SYSTEM_NAME:-SteamOS-DIY}"
DELAY_SHORT="${SPLASH_DELAY_SHORT:-1.5}"
DELAY_LONG="${SPLASH_DELAY_LONG:-3.0}"
STEAMOS_USER="${STEAMOS_USER:-user}"

LOCK_FILE="/tmp/steamos-splash.lock"

tty_out() {
    # Pulizia preventiva della riga per evitare sovrapposizioni
    echo -ne "\033[2K" > /dev/tty 2>/dev/null || true
    echo -ne "$1" > /dev/tty 2>/dev/null || echo -ne "$1"
}

# Reset totale e nascondi cursore
tty_out '\033c'
setterm -cursor off 2>/dev/null || true

# --- 2. LOGICA STATI ---
CYAN='\e[1;36m'; GREEN='\e[1;32m'; RED='\e[1;31m'; YELLOW='\e[1;33m'
WHITE='\e[1;37m'; GRAY='\e[1;30m'; RESET='\e[0m'
PAD="            "

case "${1:-}" in
    "game")     rm -f "$LOCK_FILE" 2>/dev/null; COLOR=$GREEN; MODE="Game Mode"; STAT="Launching..."; DELAY=$DELAY_SHORT ;;
    "desktop")  rm -f "$LOCK_FILE" 2>/dev/null; COLOR=$CYAN;  MODE="Desktop Mode"; STAT="Switching..."; DELAY=$DELAY_SHORT ;;
    "reboot")   COLOR=$YELLOW; MODE="System"; STAT="Rebooting..."; DELAY=1.0 ;;
    "shutdown") COLOR=$RED;    MODE="System"; STAT="Shutting down..."; DELAY=1.0 ;;
    *)
        # Controllo automatico se chiamato senza argomenti
        if systemctl list-jobs | grep -q "reboot.target"; then
            COLOR=$YELLOW; MODE="System"; STAT="Rebooting..."; DELAY=$DELAY_LONG
        elif systemctl list-jobs | grep -qE "shutdown.target|poweroff.target|halt.target"; then
            COLOR=$RED;    MODE="System"; STAT="Shutting down..."; DELAY=$DELAY_LONG
        else
            [[ -f "$LOCK_FILE" ]] && exit 0
            touch "$LOCK_FILE" 2>/dev/null
            COLOR=$WHITE;  MODE="Wait";   STAT="Processing..."; DELAY=$DELAY_SHORT
        fi
        ;;
esac

# --- 3. RENDERING (ASCII Art Steam-ish) ---
OUT="\n\n\n\n\n\n"
OUT+="${PAD}${COLOR}      ◢◤  ◢◤      ${RESET}   ${WHITE}${STEAMOS_USER}${RESET}@${WHITE}${SYSTEM_NAME}${RESET}\n"
OUT+="${PAD}${COLOR}    ◢◤      ◢◤    ${RESET}   ${GRAY}-------------------${RESET}\n"
OUT+="${PAD}${COLOR}  ◢◤          ◢◤  ${RESET}   ${WHITE}OS    : ${SYSTEM_NAME}\n"
OUT+="${PAD}${COLOR}    ◢◤      ◢◤    ${RESET}   ${WHITE}Mode  : ${COLOR}${MODE}${RESET}\n"
OUT+="${PAD}${COLOR}      ◢◤  ◢◤      ${RESET}   ${WHITE}Status: ${GRAY}${STAT}${RESET}\n"

tty_out "$OUT"
sleep "${DELAY}"
