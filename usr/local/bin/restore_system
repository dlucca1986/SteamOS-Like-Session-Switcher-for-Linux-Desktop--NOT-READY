#!/bin/bash
# =============================================================================
# PROJECT:      SSOTH - System Restore Tool (Steam-DIY)
# DESCRIPTION:  Restores system from a mirror backup tarball using rsync.
#               Maintains original permissions, symlinks, and ownership.
# LICENSE:      MIT
# =============================================================================

# --- 1. CORE INITIALIZATION ---
MASTER_CONFIG="/etc/default/steamos-diy"
if [ -f "$MASTER_CONFIG" ]; then
    source "$MASTER_CONFIG"
else
    echo "FATAL ERROR: Master config not found at $MASTER_CONFIG"
    exit 1
fi

BACKUP_DIR="${CONFIG_DIR}/backups"

# --- 2. BACKUP SELECTION ---
# If no argument is provided, automatically pick the most recent backup
if [ -z "$1" ]; then
    LATEST_BKP=$(ls -t "${BACKUP_DIR}"/*.tar.gz 2>/dev/null | head -n1)
    if [ -z "$LATEST_BKP" ]; then
        echo "ERROR: No backup found in ${BACKUP_DIR}"
        exit 1
    fi
    SELECTED_BKP="$LATEST_BKP"
else
    SELECTED_BKP="$1"
fi

# --- 3. PRE-FLIGHT CHECKS ---
# Must be run as root to write to /usr and /etc
if [ "$EUID" -ne 0 ]; then
    echo "ERROR: This script must be run with sudo: sudo $0"
    exit 1
fi

# Ensure rsync is installed
if ! command -v rsync >/dev/null 2>&1; then
    echo "ERROR: 'rsync' is not installed. Please install it to proceed."
    exit 1
fi

echo "--- SSOTH RESTORE INITIALIZED ---"
echo "Target Backup: $SELECTED_BKP"
echo "WARNING: This will overwrite current system configurations and binaries!"
read -p "Are you sure you want to proceed? (y/N): " confirm
if [[ $confirm != [yY] ]]; then
    echo "Restore cancelled by user."
    exit 0
fi

# --- 4. EXECUTION (Safe Extraction) ---
# Create a temporary directory for safe unpacking
TMP_RESTORE=$(mktemp -d)
echo "[1/3] Extracting archive to temporary storage..."
tar -xzf "$SELECTED_BKP" -C "$TMP_RESTORE"

echo "[2/3] Restoring system files via rsync..."
# -a: Archive mode (preserves permissions, symlinks, timestamps)
# -v: Verbose output
# -P: Show progress
# -H: Preserve hard links
# -X: Preserve extended attributes (important for some system files)
rsync -avPHX "$TMP_RESTORE/" /

# --- 5. CLEANUP & RELOAD ---
echo "[3/3] Finalizing: Cleaning up and reloading systemd daemons..."
rm -rf "$TMP_RESTORE"
systemctl daemon-reload

echo "------------------------------------------------"
echo "âœ… RESTORE COMPLETED SUCCESSFULLY!"
echo "System tools and configs have been rolled back."
echo "------------------------------------------------"
