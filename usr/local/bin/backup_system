#!/bin/bash
# =============================================================================
# PROJECT:      SSOTH - Backup Tool (Mirror Logic)
# DESCRIPTION:  Creates a mirror archive of system tools and configs.
#               Maintains full path structure for seamless restoration.
# LICENSE:      MIT
# =============================================================================

# --- 1. CORE INITIALIZATION ---
MASTER_CONFIG="/etc/default/steamos-diy"

if [ -f "$MASTER_CONFIG" ]; then
    source "$MASTER_CONFIG"
else
    echo "ERROR: Master SSoT file not found at $MASTER_CONFIG"
    exit 1
fi

# Set backup naming and destination
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="backup_${TIMESTAMP}"
BACKUP_ROOT_DIR="${CONFIG_DIR}/backups"
ROOT_BKP="${BACKUP_ROOT_DIR}/${BACKUP_NAME}"

# Ensure the backup directory exists
mkdir -p "$BACKUP_ROOT_DIR"

echo "--- SSOTH Backup Initialized: $BACKUP_NAME ---"

# --- 2. MIRROR CONFIG_DIR (Home Configs) ---
echo "[1/4] Mirroring user configurations: ${CONFIG_DIR}"
# Create parent structure and sync files, excluding existing backups
mkdir -p "$ROOT_BKP$(dirname "${CONFIG_DIR}")"
rsync -av --exclude='backups' "${CONFIG_DIR}" "$ROOT_BKP$(dirname "${CONFIG_DIR}")/"

# --- 3. MIRROR SYSTEMD (Autologin/Service overrides) ---
echo "[2/4] Mirroring systemd overrides..."
SYSTEMD_DIR="/etc/systemd/system/getty@tty1.service.d"
if [ -d "$SYSTEMD_DIR" ]; then
    mkdir -p "$ROOT_BKP$SYSTEMD_DIR"
    cp -r "$SYSTEMD_DIR/." "$ROOT_BKP$SYSTEMD_DIR/"
fi

# --- 4. MIRROR BINARIES & MASTER CONFIG ---
echo "[3/4] Mirroring system binaries and master config..."
BIN_DIR="/usr/local/bin"
BINARIES=("sdy" "steamos-diy-control" "steamos-helpers" "steamos-session-launch" "steamos-session-select")

# Backup specified binaries
mkdir -p "$ROOT_BKP$BIN_DIR"
for bin in "${BINARIES[@]}"; do
    if [ -e "$BIN_DIR/$bin" ]; then
        cp -p "$BIN_DIR/$bin" "$ROOT_BKP$BIN_DIR/"
        echo "  -> $bin: OK"
    fi
done

# Backup the Master SSoT file (Critical for restore)
mkdir -p "$ROOT_BKP$(dirname "$MASTER_CONFIG")"
cp -p "$MASTER_CONFIG" "$ROOT_BKP$MASTER_CONFIG"

# --- 5. COMPRESSION ---
echo "[4/4] Creating compressed archive..."
# Using -C to change directory and avoid storing absolute paths of the build dir
cd "$BACKUP_ROOT_DIR" || exit 1
tar -czf "${BACKUP_NAME}.tar.gz" -C "$BACKUP_NAME" .

# Cleanup the temporary mirror folder
rm -rf "$BACKUP_NAME"

echo "------------------------------------------------"
echo "âœ… SUCCESS! Mirror backup created."
echo "Structure follows system paths for easy restoration."
echo "Archive: ${BACKUP_ROOT_DIR}/${BACKUP_NAME}.tar.gz"
echo "------------------------------------------------"
