#!/bin/bash
# =============================================================================
# SteamMachine-DIY - SDY Game Wrapper
# =============================================================================
# Script:      sdy
# Version:     4.0.0
# Philosophy:  KISS (Keep It Simple, Stupid)
# Description: Intelligent wrapper for Steam games. Handles per-game 
#              configurations, command injection (prefixes/args), and 
#              synchronizes diagnostic markers with Steam logs.
# Repository: https://github.com/dlucca1986/SteamMachine-DIY
# Path:        /usr/local/bin/sdy
# License: MIT
# =============================================================================

# --- 1. CARICAMENTO AGNOSTICO (SSoT) ---
# Carichiamo il Master di Sistema (IdentitÃ  e Path)
if [ -f "/etc/default/steamos-diy" ]; then
    source "/etc/default/steamos-diy"
else
    # Fallback estremo se il file in /etc non esiste (Agnosticismo)
    export STEAMOS_USER=$(whoami)
    export USER_HOME=$HOME
    export CONF_DIR="${USER_HOME}/.config/steamos-diy"
    export LOG_FILE="${CONF_DIR}/session.log"
fi

# Carichiamo il Config Utente (Preferenze e Globali)
[ -f "${CONF_DIR}/config" ] && source "${CONF_DIR}/config"

# Funzione Log (Agnostica e Pulita)
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [SDY] $1" >> "${LOG_FILE}" 2>/dev/null || true
}

# --- 2. IDENTIFICAZIONE GIOCO ---
RAW_PATH="${@: -1}"
# Risolviamo il path reale (importante per i link simbolici di Steam)
REAL_PATH=$(readlink -f "$RAW_PATH" 2>/dev/null || echo "$RAW_PATH")
EXE_NAME=$(basename "${REAL_PATH%.*}")

# Prepariamo i valori globali (dal file Master Utente)
FINAL_PRE="${GLOBAL_GAME_PRE_COMMAND:-}"
FINAL_ARGS="${GLOBAL_GAME_ARGS:-}"
SPECIFIC_CONF=""

# --- 3. IL BIANCONIGLIO (Ricerca Eccezioni) ---
# Risaliamo fino a 3 livelli partendo dalla cartella dell'eseguibile
CURRENT_DIR=$(dirname "$REAL_PATH")
for i in {1..3}; do
    DIR_NAME=$(basename "$CURRENT_DIR")

    # Muro di sicurezza: non risaliamo oltre la HOME o cartelle di sistema
    [[ "$DIR_NAME" =~ ^(common|steamapps|GOG\ Games|Games)$ ]] && break
    [[ "$CURRENT_DIR" == "$USER_HOME" ]] && break

    # Cerca match con nome cartella o nome eseguibile
    if [ -f "${GAMES_CONF_DIR}/${DIR_NAME}.conf" ]; then
        SPECIFIC_CONF="${GAMES_CONF_DIR}/${DIR_NAME}.conf"
        break
    elif [ -f "${GAMES_CONF_DIR}/${EXE_NAME}.conf" ]; then
        SPECIFIC_CONF="${GAMES_CONF_DIR}/${EXE_NAME}.conf"
        break
    fi
    CURRENT_DIR=$(dirname "$CURRENT_DIR")
done

# --- 4. APPLICAZIONE OVERRIDE (Il famoso 2%) ---
if [ -n "$SPECIFIC_CONF" ]; then
    log "Override detected: $(basename "$SPECIFIC_CONF")"
    source "$SPECIFIC_CONF"
    # Se il file specifico ha definito variabili locali, vincono sui globali
    FINAL_PRE="${GAME_PRE_COMMAND:-$FINAL_PRE}"
    FINAL_ARGS="${GAME_ARGS:-$FINAL_ARGS}"
fi

# --- 5. ESECUZIONE ---
log "Launching $EXE_NAME (Args: ${FINAL_ARGS:-none})"

# Ricostruiamo l'array degli argomenti per Steam
# Rimpiazziamo l'ultimo argomento originale con il path risolto
set -- "${@:1:$#-1}" "$REAL_PATH"

# Il grande salto: eseguiamo il comando finale
exec $FINAL_PRE "$@" $FINAL_ARGS

