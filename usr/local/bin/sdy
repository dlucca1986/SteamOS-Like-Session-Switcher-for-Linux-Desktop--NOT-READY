#!/bin/bash
# =============================================================================
# SteamMachine-DIY - SDY Game Wrapper
# =============================================================================
# Script:      sdy
# Version:     4.0.0
# Philosophy:  KISS (Keep It Simple, Stupid)
# Description: [Descrizione breve e dritta al punto]
# Repository:  https://github.com/dlucca1986/SteamMachine-DIY
# License:     MIT
# =============================================================================

set -eou pipefail

# --- 1. CARICAMENTO GERARCHICO (SSoT) ---
source "/usr/share/steamos-diy/defaults" 2>/dev/null || { echo "Defaults missing"; exit 1; }
source "/etc/default/steamos-diy" 2>/dev/null || { echo "Master Config missing"; exit 1; }

# Funzione Log Uniformata
log() {
    local level=$1
    local msg=$2
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [SDY] [$level] $msg" >> "${LOG_FILE}" 2>/dev/null || true
    echo "[$level] $msg" | systemd-cat -t "steamos-diy"
}

# Assicuriamoci che la cartella dei giochi esista (GAMES_CONF_DIR definita nel Master)
mkdir -p "${GAMES_CONF_DIR}"

# --- 2. IDENTIFICAZIONE GIOCO ---
# Prendiamo l'ultimo argomento (solitamente il percorso dell'eseguibile)
RAW_PATH="${@: -1}"
REAL_PATH=$(readlink -f "$RAW_PATH" 2>/dev/null || echo "$RAW_PATH")

if [ -d "$REAL_PATH" ]; then
    FOLDER_NAME=$(basename "$REAL_PATH")
else
    FOLDER_NAME=$(basename "$(dirname "$REAL_PATH")")
fi

GAME_CONF="${GAMES_CONF_DIR}/${FOLDER_NAME}.conf"
GLOBAL_GAME_CONF="${GAMES_CONF_DIR}/global.conf"

# --- 3. GENERAZIONE AUTOMATICA CONFIG (Standardizzata) ---
[ ! -f "$GLOBAL_GAME_CONF" ] && echo -e "export GAME_PRE_COMMAND=\"\"\nexport GAME_ARGS=\"\"" > "$GLOBAL_GAME_CONF"

if [ ! -f "$GAME_CONF" ]; then
    echo -e "# Config for $FOLDER_NAME\nexport GAME_PRE_COMMAND=\"\"\nexport GAME_ARGS=\"\"" > "$GAME_CONF"
    log "INFO" "Created new game config: ${FOLDER_NAME}.conf"
fi

# --- 4. CARICAMENTO ED ESECUZIONE ---
source "$GLOBAL_GAME_CONF"
source "$GAME_CONF"

log "LAUNCH" "Executing game: $FOLDER_NAME"

# Esecuzione dinamica
eval ${GAME_PRE_COMMAND} "$@" ${GAME_ARGS}
