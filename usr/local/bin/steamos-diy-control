#!/usr/bin/env python3
import sys
import os
import subprocess
import re
import getpass
import socket
from PyQt6.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout,
                             QHBoxLayout, QLabel, QLineEdit, QPushButton,
                             QFrame, QTextEdit, QTabWidget, QGridLayout,
                             QListWidget, QCompleter)
from PyQt6.QtCore import Qt, QTimer, QRegularExpression
from PyQt6.QtGui import QPalette, QFont, QSyntaxHighlighter, QTextCharFormat, QColor

# --- 1. SSoT NATIVE BRIDGE (RECURSIVE VARIABLE EXPANSION) ---
def get_master_config():
    """Legge la gerarchia SSoT (Defaults + Master) espandendo le variabili ricorsivamente."""
    defaults_path = "/usr/share/steamos-diy/defaults"
    master_path = "/etc/default/steamos-diy"
    current_user = getpass.getuser()

    # Fallbacks allineati alla filosofia Strict
    config = {
        "STEAMOS_USER": current_user,
        "CONF_DIR": f"/home/{current_user}/.config/steamos-diy",
        "GAMES_CONF_DIR": f"/home/{current_user}/.config/steamos-diy/games",
        "LOG_FILE": f"/home/{current_user}/.config/steamos-diy/session.log",
        "STEAM_LOG": f"/home/{current_user}/.local/share/Steam/logs/console-linux.txt",
        "SYSTEM_NAME": "SteamOS-DIY"
    }

    raw_vars = {}
    # Caricamento sequenziale: i valori in master_path sovrascrivono defaults_path
    for p in [defaults_path, master_path]:
        if os.path.exists(p):
            try:
                with open(p, "r") as f:
                    for line in f:
                        line = line.split('#')[0].replace("export ", "").strip()
                        if "=" in line:
                            key, val = line.split("=", 1)
                            raw_vars[key.strip()] = val.strip().strip('"').strip("'")
            except Exception as e:
                print(f"Error reading {p}: {e}")

    # Funzione di espansione ricorsiva (Simula Bash)
    def resolve(text):
        if not isinstance(text, str): return text
        # Risolve l'utente prima di tutto
        final_user = raw_vars.get("STEAMOS_USER", current_user)
        text = text.replace("${STEAMOS_USER}", final_user).replace("$STEAMOS_USER", final_user)
        
        # Tenta fino a 3 passaggi di espansione per variabili concatenate
        for _ in range(3):
            changed = False
            for k, v in raw_vars.items():
                placeholders = [f"${{{k}}}", f"${k}"]
                for p in placeholders:
                    if p in text:
                        text = text.replace(p, v)
                        changed = True
            if not changed: break
        return text

    # Aggiornamento finale del dizionario config
    for key in config:
        if key in raw_vars:
            config[key] = resolve(raw_vars[key])
        else:
            config[key] = resolve(config[key])

    return config

# Inizializzazione Globale
MASTER = get_master_config()
CONFIG_DIR = MASTER["CONF_DIR"]
GAMES_CONF_DIR = MASTER["GAMES_CONF_DIR"]
CONFIG_PATH = os.path.join(CONFIG_DIR, "config")
CONFIG_EXAMPLE_PATH = os.path.join(CONFIG_DIR, "config.example")
SDY_EXAMPLE_PATH = os.path.join(GAMES_CONF_DIR, "sdy.example")
LOG_PATH = MASTER["LOG_FILE"]
STEAM_LOG = MASTER["STEAM_LOG"]
SYSTEM_NAME = MASTER["SYSTEM_NAME"]

SUGGESTIONS = [
    "width", "height", "refresh", "fps-limit", "fsr-sharpness", "nis-sharpness",
    "rt", "prefer-output", "hdr-enabled", "force-composition", "xwayland-count",
    "GAMESCOPE_COMMAND", "ENABLE_VULKAN", "STEAM_COMPAT_DATA_PATH",
    "MESA_DISK_CACHE_SINGLE_FILE", "vblank_mode", "mangohud",
    "adaptive_sync_ignore_overlay", "STEAM_MULTIPLE_XWAYLANDS", "POST_LAUNCH_CMD"
]

# --- 2. HIGHLIGHTERS ---
class ConfHighlighter(QSyntaxHighlighter):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.rules = []
        fmt_k = QTextCharFormat(); fmt_k.setForeground(QColor("#1a9fff")); fmt_k.setFontWeight(QFont.Weight.Bold)
        fmt_n = QTextCharFormat(); fmt_n.setForeground(QColor("#f49b00")); fmt_n.setFontWeight(QFont.Weight.Bold)
        fmt_c = QTextCharFormat(); fmt_c.setForeground(QColor("#7f8c8d")); fmt_c.setFontItalic(True)
        fmt_v = QTextCharFormat(); fmt_v.setForeground(QColor("#ffffff"))
        self.rules.append((QRegularExpression(r"^[A-Za-z0-9_]+(?==)"), fmt_k))
        self.rules.append((QRegularExpression(r"\b[0-9]+\b"), fmt_n))
        self.rules.append((QRegularExpression(r"#.*"), fmt_c))
        self.rules.append((QRegularExpression(r"(?<==).+"), fmt_v))

    def highlightBlock(self, text):
        for pattern, fmt in self.rules:
            it = pattern.globalMatch(text)
            while it.hasNext():
                match = it.next()
                self.setFormat(match.capturedStart(), match.capturedLength(), fmt)

class LogHighlighter(QSyntaxHighlighter):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.rules = []
        palette = QApplication.palette()
        color_accent = palette.color(QPalette.ColorRole.Highlight)
        fmt_err = QTextCharFormat(); fmt_err.setForeground(QColor("#e74c3c")); fmt_err.setFontWeight(QFont.Weight.Bold)
        fmt_warn = QTextCharFormat(); fmt_warn.setForeground(QColor("#f1c40f"))
        fmt_info = QTextCharFormat(); fmt_info.setForeground(color_accent)
        fmt_date = QTextCharFormat(); fmt_date.setForeground(palette.color(QPalette.ColorRole.PlaceholderText))
        fmt_tag = QTextCharFormat(); fmt_tag.setForeground(color_accent); fmt_tag.setFontWeight(QFont.Weight.Bold)
        self.rules.append((QRegularExpression(r"\[ERROR\]|CRITICAL|FAILED|failed|Error|terminate"), fmt_err))
        self.rules.append((QRegularExpression(r"\[Warn\]|WARNING|Warn"), fmt_warn))
        self.rules.append((QRegularExpression(r"\[LAUNCH\]|\[Info\]|gamescope|wlserver|\[INIT\]|\[EXIT\]|\[SDY_START\]"), fmt_info))
        self.rules.append((QRegularExpression(r"\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}"), fmt_date))
        self.rules.append((QRegularExpression(r"\[[A-Za-z0-9_-]+\]"), fmt_tag))

    def highlightBlock(self, text):
        for pattern, fmt in self.rules:
            it = pattern.globalMatch(text)
            while it.hasNext():
                match = it.next()
                self.setFormat(match.capturedStart(), match.capturedLength(), fmt)

class SmartTextEdit(QTextEdit):
    def __init__(self, parent=None):
        super().__init__(parent)
        self._completer = QCompleter(SUGGESTIONS)
        self._completer.setWidget(self)
        self._completer.setCaseSensitivity(Qt.CaseSensitivity.CaseInsensitive)
        self._completer.setCompletionMode(QCompleter.CompletionMode.PopupCompletion)
        self._completer.activated.connect(self.insert_completion)

    def insert_completion(self, completion):
        tc = self.textCursor()
        tc.movePosition(tc.MoveOperation.Left, tc.MoveMode.KeepAnchor, len(self._completer.completionPrefix()))
        tc.insertText(completion)
        self.setTextCursor(tc)

    def text_under_cursor(self):
        tc = self.textCursor()
        tc.select(tc.SelectionType.WordUnderCursor)
        return tc.selectedText()

    def keyPressEvent(self, event):
        if self._completer.popup().isVisible():
            if event.key() in (Qt.Key.Key_Enter, Qt.Key.Key_Return, Qt.Key.Key_Escape, Qt.Key.Key_Tab):
                event.ignore(); return
        super().keyPressEvent(event)
        prefix = self.text_under_cursor()
        if prefix and len(prefix) >= 2:
            self._completer.setCompletionPrefix(prefix)
            cr = self.cursorRect()
            cr.setWidth(self._completer.popup().sizeHintForColumn(0) + self._completer.popup().verticalScrollBar().sizeHint().width())
            self._completer.complete(cr)
        else: self._completer.popup().hide()

# --- 3. MAIN WINDOW ---
class SteamDIYControl(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle(f"{SYSTEM_NAME} Control Center")
        self.setMinimumSize(1000, 800)
        self.curr_user = MASTER["STEAMOS_USER"]
        self.curr_host = socket.gethostname()
        self.init_ui()
        self.load_main_config()
        self.refresh_games_list()

    def run_cmd(self, cmd):
        try: return subprocess.check_output(cmd, shell=True, text=True, stderr=subprocess.DEVNULL).strip()
        except: return "N/A"

    def init_ui(self):
        palette = self.palette(); accent_hex = palette.color(QPalette.ColorRole.Highlight).name()
        central = QWidget(); self.setCentralWidget(central)
        layout = QVBoxLayout(central); self.tabs = QTabWidget(); layout.addWidget(self.tabs)

        # TAB 1: GAMESCOPE
        self.tab_gs = QWidget(); gs_lay = QVBoxLayout(self.tab_gs); gs_head = QHBoxLayout()
        self.gs_title = QLabel(f"Main Config: {CONFIG_PATH}")
        self.gs_title.setStyleSheet(f"color: {accent_hex}; font-weight: bold;")
        self.gs_ex_btn = QPushButton(" Open Example"); self.gs_ex_btn.clicked.connect(self.toggle_main_example)
        gs_head.addWidget(self.gs_title); gs_head.addStretch(); gs_head.addWidget(self.gs_ex_btn)
        self.gs_edit = SmartTextEdit(); self.gs_edit.setFont(QFont("Monospace", 10))
        self.gs_highlighter = ConfHighlighter(self.gs_edit.document())
        self.gs_save_btn = QPushButton(" Save Main Config"); self.gs_save_btn.clicked.connect(self.save_main_config)
        self.gs_save_btn.setMinimumHeight(40)
        gs_lay.addLayout(gs_head); gs_lay.addWidget(self.gs_edit); gs_lay.addWidget(self.gs_save_btn)
        self.tabs.addTab(self.tab_gs, "Gamescope")

        # TAB 2: SYSTEM INFO
        self.tab_info = QWidget(); info_lay = QVBoxLayout(self.tab_info); cols = QHBoxLayout()
        self.sw_labels = {}; self.hw_labels = {}
        for title, container, keys in [("SOFTWARE", self.sw_labels, ["OS", "Kernel", "Session"]),
                                       ("HARDWARE", self.hw_labels, ["CPU", "GPU", "Memory Usage"])]:
            vbox = QVBoxLayout(); vbox.addWidget(QLabel(f"<b>{title}</b>"))
            frame = QFrame(); frame.setFrameShape(QFrame.Shape.StyledPanel); grid = QGridLayout(frame)
            for i, k in enumerate(keys):
                grid.addWidget(QLabel(f"{k}:"), i, 0)
                val = QLabel("..."); container[k] = val; grid.addWidget(val, i, 1)
            vbox.addWidget(frame); cols.addLayout(vbox)
        info_lay.addLayout(cols)
        self.gpu_log = QTextEdit(); self.gpu_log.setReadOnly(True); self.gpu_log.setFont(QFont("Monospace", 9))
        info_lay.addWidget(QLabel("<b>DETAILED PCI DEVICES</b>")); info_lay.addWidget(self.gpu_log)
        self.tabs.addTab(self.tab_info, "System Info")

        # TAB 3: CONSOLE
        self.tab_console = QWidget(); console_lay = QVBoxLayout(self.tab_console)
        self.console_out = QTextEdit(); self.console_out.setReadOnly(True); self.console_out.setFont(QFont("Monospace", 10))
        self.console_out.setStyleSheet("background-color: #1e1e1e; color: #ffffff;")
        console_input_lay = QHBoxLayout()
        self.console_prompt_lbl = QLabel(f"<b>{self.curr_user}@{self.curr_host}:~$</b>")
        self.console_prompt_lbl.setStyleSheet(f"color: {accent_hex};")
        self.console_input = QLineEdit(); self.console_input.returnPressed.connect(self.execute_console_command)
        self.btn_full_term = QPushButton("Open Terminal"); self.btn_full_term.clicked.connect(self.open_native_terminal)
        console_input_lay.addWidget(self.console_prompt_lbl); console_input_lay.addWidget(self.console_input); console_input_lay.addWidget(self.btn_full_term)
        console_lay.addWidget(self.console_out); console_lay.addLayout(console_input_lay)
        self.tabs.addTab(self.tab_console, "Console")

        # TAB 4: SDY CONFIG
        self.tab_sdy = QWidget(); sdy_lay = QHBoxLayout(self.tab_sdy); side = QVBoxLayout()
        self.btn_target = QPushButton("Target Last Game"); self.btn_target.clicked.connect(self.target_last_game)
        self.games_list = QListWidget(); self.games_list.setFixedWidth(220); self.games_list.itemClicked.connect(self.load_selected_game_conf)
        side.addWidget(self.btn_target); side.addWidget(self.games_list)
        editor_side = QVBoxLayout(); edit_head = QHBoxLayout()
        self.sdy_curr_lbl = QLabel("Select a game..."); self.sdy_curr_lbl.setStyleSheet(f"color: {accent_hex}; font-weight: bold;")
        self.sdy_ex_btn = QPushButton(" Open Example"); self.sdy_ex_btn.clicked.connect(self.toggle_sdy_example)
        edit_head.addWidget(self.sdy_curr_lbl); edit_head.addStretch(); edit_head.addWidget(self.sdy_ex_btn)
        self.sdy_edit = SmartTextEdit(); self.sdy_edit.setFont(QFont("Monospace", 10))
        self.sdy_highlighter = ConfHighlighter(self.sdy_edit.document())
        self.sdy_save_btn = QPushButton(" Save Game Config"); self.sdy_save_btn.clicked.connect(self.save_sdy_conf)
        editor_side.addLayout(edit_head); editor_side.addWidget(self.sdy_edit); editor_side.addWidget(self.sdy_save_btn)
        sdy_lay.addLayout(side); sdy_lay.addLayout(editor_side)
        self.tabs.addTab(self.tab_sdy, "Sdy Config")

        # TAB 5: LOGS
        self.tab_logs = QWidget(); log_lay = QVBoxLayout(self.tab_logs); l_tools = QHBoxLayout()
        self.copy_btn = QPushButton(" Copy All"); self.copy_btn.clicked.connect(self.copy_to_clipboard)
        self.clear_btn = QPushButton(" Clear Log"); self.clear_btn.clicked.connect(self.clear_log)
        self.log_search = QLineEdit(); self.log_search.setPlaceholderText("Filter logs..."); self.log_search.textChanged.connect(self.load_log_content)
        l_tools.addWidget(self.copy_btn); l_tools.addWidget(self.clear_btn); l_tools.addStretch(); l_tools.addWidget(self.log_search)
        log_lay.addLayout(l_tools)
        self.log_out = QTextEdit(); self.log_out.setReadOnly(True); self.log_out.setFont(QFont("Monospace", 10))
        self.log_highlighter = LogHighlighter(self.log_out.document())
        log_lay.addWidget(self.log_out)
        self.tabs.addTab(self.tab_logs, "System Logs")

        self.tabs.currentChanged.connect(self.on_tab_changed)
        self.dyn_timer = QTimer(); self.dyn_timer.timeout.connect(self.update_dynamic_info)
        self.dyn_timer.start(3000); self.update_system_info()

    # --- LOGIC METHODS ---
    def execute_console_command(self):
        cmd = self.console_input.text().strip()
        if not cmd: return
        self.console_out.append(f"<span style='color:cyan;'><b>{self.curr_user}@{self.curr_host}:~$</b></span> {cmd}")
        try:
            res = subprocess.run(cmd, shell=True, text=True, capture_output=True)
            out = res.stdout if res.stdout else res.stderr
            if out: self.console_out.append(re.sub(r'\x1b\[[0-9;]*[mK]', '', out))
        except Exception as e: self.console_out.append(f"Error: {e}")
        self.console_input.clear()

    def open_native_terminal(self):
        for t in ["konsole", "gnome-terminal", "xterm"]:
            try: subprocess.Popen([t], start_new_session=True); return
            except: continue

    def load_main_config(self):
        if os.path.exists(CONFIG_PATH):
            with open(CONFIG_PATH, "r") as f: self.gs_edit.setPlainText(f.read())
        else:
            self.gs_edit.setPlainText(f"# Config not found at {CONFIG_PATH}")
        self.gs_title.setText(f"Main Config: {CONFIG_PATH}")

    def toggle_main_example(self):
        if "Example" in self.gs_ex_btn.text():
            if os.path.exists(CONFIG_EXAMPLE_PATH):
                with open(CONFIG_EXAMPLE_PATH, "r") as f: self.gs_edit.setPlainText(f.read())
                self.gs_title.setText("Viewing Example (Read-only)"); self.gs_ex_btn.setText(" Back to Config")
        else: self.load_main_config(); self.gs_ex_btn.setText(" Open Example")

    def save_main_config(self):
        if not os.path.exists(CONFIG_DIR):
            self.gs_save_btn.setText(" Folder Missing!"); return
        try:
            with open(CONFIG_PATH, "w") as f: f.write(self.gs_edit.toPlainText())
            self.gs_save_btn.setText(" Saved!"); QTimer.singleShot(2000, lambda: self.gs_save_btn.setText(" Save Main Config"))
        except Exception as e:
            self.gs_save_btn.setText(" Save Error")

    def refresh_games_list(self):
        self.games_list.clear()
        if os.path.exists(GAMES_CONF_DIR):
            for f in sorted([f for f in os.listdir(GAMES_CONF_DIR) if f.endswith(".conf")]): self.games_list.addItem(f)

    def load_selected_game_conf(self, item):
        if not item: return
        self.sdy_curr_lbl.setText(f"Editing: {item.text()}")
        try:
            with open(os.path.join(GAMES_CONF_DIR, item.text()), "r") as f: self.sdy_edit.setPlainText(f.read())
        except: pass

    def toggle_sdy_example(self):
        if "Example" in self.sdy_ex_btn.text():
            if os.path.exists(SDY_EXAMPLE_PATH):
                with open(SDY_EXAMPLE_PATH, "r") as f: self.sdy_edit.setPlainText(f.read())
                self.sdy_curr_lbl.setText("Viewing SDY Example"); self.sdy_ex_btn.setText(" Back")
        else: self.load_selected_game_conf(self.games_list.currentItem()); self.sdy_ex_btn.setText(" Open Example")

    def save_sdy_conf(self):
        fname = self.sdy_curr_lbl.text().replace("Editing: ", "")
        if ".conf" in fname:
            try:
                with open(os.path.join(GAMES_CONF_DIR, fname), "w") as f: f.write(self.sdy_edit.toPlainText())
                self.sdy_save_btn.setText(" Saved!"); QTimer.singleShot(2000, lambda: self.sdy_save_btn.setText(" Save Game Config"))
            except: self.sdy_save_btn.setText(" Save Error")

    def target_last_game(self):
        if not os.path.exists(STEAM_LOG): return
        # Allineato al nuovo tag SDY_START del wrapper
        raw = self.run_cmd(f"grep 'SDY_START' '{STEAM_LOG}' | tail -n1")
        match = re.search(r'START:\s*(.*?)\s*---', raw)
        if match:
            gname = match.group(1).strip()
            items = self.games_list.findItems(f"{gname}.conf", Qt.MatchFlag.MatchExactly)
            if items: self.games_list.setCurrentItem(items[0]); self.load_selected_game_conf(items[0])

    def load_log_content(self):
        if not os.path.exists(LOG_PATH):
            self.log_out.setPlainText(f"Log file not found at {LOG_PATH}")
            return
        search = self.log_search.text().lower()
        try:
            with open(LOG_PATH, "r") as f: lines = f.readlines()
            filtered = [re.sub(r'\x1b\[[0-9;]*[mK]', '', l) for l in lines[-2000:] if not search or search in l.lower()]
            self.log_out.setPlainText("".join(filtered))
            self.log_out.verticalScrollBar().setValue(self.log_out.verticalScrollBar().maximum())
        except: pass

    def update_system_info(self):
        self.sw_labels["OS"].setText(self.run_cmd("grep PRETTY_NAME /etc/os-release | cut -d'\"' -f2"))
        self.sw_labels["Kernel"].setText(self.run_cmd("uname -r"))
        self.sw_labels["Session"].setText(os.environ.get("XDG_SESSION_TYPE", "N/A").capitalize())
        self.hw_labels["CPU"].setText(self.run_cmd("grep -m1 'model name' /proc/cpuinfo | cut -d: -f2"))
        self.hw_labels["GPU"].setText(self.run_cmd("glxinfo -B | grep 'Device:' | cut -d: -f2"))
        self.gpu_log.setPlainText(self.run_cmd("lspci -vnn | grep -E 'VGA|Audio|Network' -A 2"))

    def update_dynamic_info(self):
        self.hw_labels["Memory Usage"].setText(self.run_cmd("free -h | grep Mem: | awk '{print $3 \" / \" $2}'"))

    def on_tab_changed(self, index):
        if "Logs" in self.tabs.tabText(index): self.load_log_content()

    def copy_to_clipboard(self):
        QApplication.clipboard().setText(self.log_out.toPlainText())
        self.copy_btn.setText(" Copied!"); QTimer.singleShot(1500, lambda: self.copy_btn.setText(" Copy All"))

    def clear_log(self):
        try:
            with open(LOG_PATH, 'w') as f: f.write("--- Log cleared ---\n")
            self.load_log_content()
        except: pass

if __name__ == "__main__":
    app = QApplication(sys.argv)
    win = SteamDIYControl()
    win.show()
    sys.exit(app.exec())
