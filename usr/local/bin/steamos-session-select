#!/bin/bash
# =============================================================================
# SteamOS-DIY - Intelligent Session Selector (Agnostic & Safe Edition)
# =============================================================================
set -eou pipefail

# --- 1. CARICAMENTO GERARCHICO (SSoT) ---
source "/usr/share/steamos-diy/defaults" 2>/dev/null || { echo "Defaults missing"; exit 1; }
source "/etc/default/steamos-diy" 2>/dev/null || { echo "Master Config missing"; exit 1; }

log() {
    local msg=$1
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [Session-Select] $msg" >> "${LOG_FILE}" 2>/dev/null || true
    echo "$msg" | systemd-cat -t "steamos-diy"
}

TARGET_ENV=${1:-""}
DETACH_FLAG=${2:-""}

# --- 2. LOGICA DI DISTACCO (Agnostica) ---
if [[ "$DETACH_FLAG" != "--detached" ]]; then
    log "Detaching session switch for user: ${STEAMOS_USER}..."
    systemd-run --user --collect "${BIN_SESSION_SELECT}" "$TARGET_ENV" --detached
    exit 0
fi

log "--- SWITCH INITIATED --- Target Environment: $TARGET_ENV"

# --- 3. ESECUZIONE TRANSIZIONE CON PROTEZIONE ---
case "$TARGET_ENV" in
    "plasma" | "desktop")
        if systemctl is-active --quiet "steamos-desktop@${STEAMOS_USER}.service"; then
            log "Notice: Desktop Mode is already active. Ignoring request."
            exit 0
        fi
        log "Transitioning to Desktop Mode..."
        sudo /usr/bin/systemctl start "steamos-desktop@${STEAMOS_USER}.service"
        ;;

    "gamescope" | "steam" | "game")
        if systemctl is-active --quiet "steamos-gamemode@${STEAMOS_USER}.service"; then
            log "Notice: Game Mode is already active. Ignoring request."
            exit 0
        fi
        log "Transitioning to Game Mode..."
        sudo /usr/bin/systemctl start "steamos-gamemode@${STEAMOS_USER}.service"
        ;;

    *)
        log "Error: Invalid target '$TARGET_ENV' requested."
        exit 1
        ;;
esac

log "Request sent to systemd. Transition in progress."
