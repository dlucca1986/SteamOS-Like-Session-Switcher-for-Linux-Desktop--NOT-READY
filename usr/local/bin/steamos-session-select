#!/bin/bash
# =============================================================================
# PROJECT:     SSOTH - Session Switcher
# DESCRIPTION: Dispatcher to trigger session switches between Steam and Desktop.
#              Ensures atomic state updates and graceful session termination.
# LICENSE:     MIT
# =============================================================================

# --- 1. CORE INITIALIZATION ---
MASTER_CONFIG="/etc/default/steamos-diy"
if [ -f "$MASTER_CONFIG" ]; then
    source "$MASTER_CONFIG"
else
    echo "FATAL ERROR: Master config not found at $MASTER_CONFIG"
    exit 1
fi

# Precise timestamp for professional logging
get_timestamp() {
    date "+%Y-%m-%d %H:%M:%S.%3N"
}

# Standardized logging for trigger actions
log_action() {
    echo "[$(get_timestamp)] [TRIGGER] $1" >> "${LOG_FILE}"
}

display_usage() {
    echo "Usage: $(basename "$0") {steam|desktop}"
}

# --- 2. MAIN EXECUTION LOGIC ---
case "$1" in
    "plasma"|"desktop")
        log_action "Switch to DESKTOP requested."

        # Atomic write to prevent file corruption during power-off
        echo "desktop" > "${NEXT_SESSION_FILE}.tmp" && mv "${NEXT_SESSION_FILE}.tmp" "${NEXT_SESSION_FILE}"

        # Graceful Steam shutdown for Linux
        steam -shutdown >> "${LOG_FILE}" 2>&1
        ;;

    "steam")

        log_action "Switch to STEAM requested."

        # Atomic write
        echo "steam" > "${NEXT_SESSION_FILE}.tmp" && mv "${NEXT_SESSION_FILE}.tmp" "${NEXT_SESSION_FILE}"

        # Graceful Plasma 6 logout via D-Bus
        qdbus6 org.kde.Shutdown /Shutdown logout >> "${LOG_FILE}" 2>&1
        sleep 0.5 && clear
        ;;

    *)
        display_usage
        exit 1
        ;;
esac
