#!/bin/bash
# =============================================================================
# SteamMachine-DIY - steamos-session-select
# =============================================================================
set -eou pipefail

# --- 1. CARICAMENTO AGNOSTICO (SSoT) ---
# Ora carichiamo SOLO il Master di sistema.
source "/etc/default/steamos-diy" 2>/dev/null || { echo "Master Config missing"; exit 1; }

log() {
    local msg=$1
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [SYS] [SELECT] $msg" >> "${LOG_FILE}" 2>/dev/null || true
    echo "[SELECT] $msg" | systemd-cat -t "steamos-diy"
}

TARGET_ENV=${1:-""}
DETACH_FLAG=${2:-""}

# --- 2. LOGICA DI DISTACCO (Verificata) ---
if [[ "$DETACH_FLAG" != "--detached" ]]; then
    log "Detaching switch request for ${STEAMOS_USER}..."
    
    # La prova del nove: usiamo la variabile del Master con fallback di sicurezza
    # Questo garantisce che systemd-run sappia SEMPRE cosa eseguire.
    systemd-run --user --collect "${BIN_SESSION_SELECT:-$0}" "$TARGET_ENV" --detached
    exit 0
fi

log "--- SWITCH INITIATED --- Target: $TARGET_ENV"

# --- 3. TRANSIZIONE ---
case "$TARGET_ENV" in
    "plasma" | "desktop")
        log "Activating Desktop Mode via Systemd..."
        sudo /usr/bin/systemctl start "steamos-desktop@${STEAMOS_USER}.service"
        ;;

    "gamescope" | "steam" | "game")
        log "Activating Game Mode via Systemd..."
        sudo /usr/bin/systemctl start "steamos-gamemode@${STEAMOS_USER}.service"
        ;;

    *)
        log "Error: Invalid target '$TARGET_ENV'."
        exit 1
        ;;
esac
