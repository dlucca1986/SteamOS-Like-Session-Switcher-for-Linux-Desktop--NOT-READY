#!/bin/bash
# =============================================================================
# SteamMachine-DIY - Intelligent Universal Launcher
# =============================================================================
# Script: steamos-session-launch
# Version: 3.1.0
# Description: Agnostic session launcher for SteamOS environments.
#              Automates hardware detection, Gamescope optimization, and 
#              diagnostic log extraction for DIY Steam Machine builds.
# Repository: https://github.com/dlucca1986/SteamMachine-DIY
#
# License: MIT
# =============================================================================
set -eou pipefail

# --- 1. CONFIGURATION & AGNOSTIC ENVIRONMENT ---
# Loading the Master Global Configuration defined in Step A
GLOBAL_CONFIG="/etc/default/steamos-diy"

# [AGNOSTIC SOLUTION]: Detect UID before initialization to ensure proper bus access.
# Default to (id -u) if the variable is not present in the environment.
CURRENT_UID=$(id -u)
export DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/${CURRENT_UID}/bus"

if [[ -f "$GLOBAL_CONFIG" ]]; then
    set -a            # Enable auto-export for all sourced variables
    source "$GLOBAL_CONFIG"
    set +a            # Disable auto-export
else
    echo "[ERROR] Global configuration not found at $GLOBAL_CONFIG"
    exit 1
fi

# Derived local variables (fallback to defaults if not defined in Master Config)
readonly LOG_FILE="${LOG_FILE:-/var/log/steamos-diy.log}"
readonly STEAM_LOG_PATH="${STEAM_LOG:-$HOME/.local/share/Steam/logs/console-linux.txt}"
readonly CONFIG_FILE="${CONF_DIR:-$HOME/.config/steamos-diy}/config"

# Logging function using the LOG_TAG defined in the Master file
log() {
    local tag="$1"
    local msg="$2"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ${LOG_TAG:-[SteamOS-DIY]} [$tag] $msg" >> "$LOG_FILE" 2>/dev/null || true
}

echo "========================================" >> "$LOG_FILE"
log "INIT" "New SteamOS-DIY session initiated for user: $USER (UID: $CURRENT_UID)"

# --- 2. HARDWARE DETECTION ---
# Identify the primary connected display and its native resolution
DRM_CONN=$(grep -l "^connected" /sys/class/drm/card*-*/status | head -n1 || true)
DRM_PATH=$(dirname "$DRM_CONN")
NATIVE_RES=$(head -n1 "$DRM_PATH/modes" 2>/dev/null || echo "1280x720")
HW_W=${NATIVE_RES%x*}
HW_H=${NATIVE_RES#*x}
log "CONFIG" "Native hardware detected: ${HW_W}x${HW_H}"

# --- 3. LOCAL USER CONFIGURATION ---
# Override variables if a local user config file exists
[[ -f "$CONFIG_FILE" ]] && source "$CONFIG_FILE"

# --- 4. DYNAMIC ARGUMENTS CONSTRUCTION ---
G_OPTS=("${G_OPTS_BASE:--e}")
FINAL_W=${TARGET_WIDTH:-$HW_W}
FINAL_H=${TARGET_HEIGHT:-$HW_H}
FINAL_R=${REFRESH_RATE:-60}

# Safety Cap: Prevent resolution from exceeding physical hardware limits
if [ "$FINAL_W" -gt "$HW_W" ] || [ "$FINAL_H" -gt "$HW_H" ]; then
    log "WARN" "Requested ${FINAL_W}x${FINAL_H} exceeds hardware. Capping to native."
    FINAL_W=$HW_W; FINAL_H=$HW_H; FINAL_R=60
fi

G_OPTS+=("-W" "$FINAL_W" "-H" "$FINAL_H" "-r" "$FINAL_R")

# Feature Toggles (Agnostic implementation)
[[ "${ENABLE_HDR:-0}" == "1" ]] && G_OPTS+=("--hdr-enabled")
[[ "${ENABLE_VRR:-0}" == "1" ]] && G_OPTS+=("--adaptive-sync")
[[ "${ENABLE_MANGOAPP:-0}" == "1" ]] && G_OPTS+=("--mangoapp")

# Append extra arguments if defined in the configuration
if [[ -n "${GAMESCOPE_ARGS:-}" ]]; then
    read -r -a EXTRA <<< "$GAMESCOPE_ARGS"
    G_OPTS+=("${EXTRA[@]}")
fi

log "LAUNCH" "Gamescope OPTS: ${G_OPTS[*]}"

# --- 5. EXECUTION & WATCHDOG ---
START_TIME=$(date +%s)
G_EXIT_CODE=0

# Launching Gamescope with unbuffered logging
stdbuf -oL -eL gamescope "${G_OPTS[@]}" -- \
    steam -steamdeck -steamos3 >> "$LOG_FILE" 2>&1 || G_EXIT_CODE=$?

RUNTIME=$(( $(date +%s) - START_TIME ))

# Watchdog: If crash occurs within 10 seconds, attempt Safe Mode recovery
if [ "$G_EXIT_CODE" -ne 0 ] && [ "$RUNTIME" -lt 10 ]; then
    log "CRITICAL" "Early crash detected after ${RUNTIME}s. Recovering to Safe Mode..."
    stdbuf -oL -eL gamescope -e -W "$HW_W" -H "$HW_H" -r 60 -- \
        steam -steamdeck -steamos3 >> "$LOG_FILE" 2>&1
else
    log "EXIT" "Session finished. Exit code: $G_EXIT_CODE"
fi

# --- 6. STEAM ERROR EXTRACTOR (SDY Marker) ---
# Extracts diagnostic context from Steam logs if the session fails
if [ "$G_EXIT_CODE" -ne 0 ]; then
    if [[ -f "$STEAM_LOG_PATH" ]]; then
        LAST_START_MARKER=$(grep -a "SDY_REATTIVO_START" "$STEAM_LOG_PATH" | tail -n 1 || true)
        if [[ -n "$LAST_START_MARKER" ]]; then
            log "STEAM_ERR" ">>> Extracting diagnostic context <<<"
            grep -a -F -A 30 "$LAST_START_MARKER" "$STEAM_LOG_PATH" >> "$LOG_FILE" || true
        fi
    fi
fi
