#!/bin/bash
# =============================================================================
# PROJECT:      SteamMachine-DIY - Session Launcher
# Version:      1.0.0
# DESCRIPTION:  Core Session Manager with Dynamic Gamescope Mapping.
#               Handles seamless transitions between Steam and Desktop.
# PHILOSOPHY:   KISS (Keep It Simple, Stupid)
# REPOSITORY:   https://github.com/dlucca1986/SteamMachine-DIY
# PATH:         /usr/local/bin/steamos-session-launch
# =============================================================================

# --- 1. CORE INITIALIZATION ---
MASTER_CONFIG="/etc/default/steamos-diy"

if [ -f "$MASTER_CONFIG" ]; then
    source "$MASTER_CONFIG"
else
    echo "FATAL ERROR: Master config not found at $MASTER_CONFIG"
    exit 1
fi

# Helper functions for precise logging.
get_timestamp() { date "+%Y-%m-%d %H:%M:%S.%3N"; }
log_info() { echo "[$(get_timestamp)] [LAUNCHER] $1" >> "${LOG_FILE}"; }

log_info "--- SYSTEM STARTUP ---"

# --- 2. MAIN EXECUTION LOOP ---
while true; do
    # Determine target session; defaults to 'steam' if missing.
    TARGET_SESSION=$(cat "${NEXT_SESSION_FILE}" 2>/dev/null || echo "steam")
    
    # Show the visual feedback on TTY1
    ssoth_banner "$TARGET_SESSION" "INITIALIZING..."
    sleep 1.2

    case "${TARGET_SESSION}" in
        "steam")
            log_info "Launching Steam Session..."

            # Reset dynamic flags
            unset GS_DYNAMIC_FLAGS
            GS_DYNAMIC_FLAGS=""

            # --- 1. DYNAMIC FLAG CONSTRUCTION ---
            # Automatically maps variables starting with GS_ to Gamescope arguments.
            if [ -f "${CONFIG_DIR}/config" ] && bash -n "${CONFIG_DIR}/config" 2>/dev/null; then
                source "${CONFIG_DIR}/config"

                while read -r line; do
                    [[ "$line" =~ ^#.*$ || -z "$line" ]] && continue

                    var_name=$(echo "$line" | cut -d'=' -f1)
                    var_val="${!var_name}"

                    # Transformation: GS_WINE_FULLSCREEN=1 -> --wine-fullscreen
                    if [[ "$var_name" == GS_* ]]; then
                        flag=$(echo "${var_name#GS_}" | tr '[:upper:]' '[:lower:]' | tr '_' '-')

                        if [ "$var_val" = "1" ]; then
                            GS_DYNAMIC_FLAGS="${GS_DYNAMIC_FLAGS} --${flag}"
                        elif [ "$var_val" != "0" ] && [ -n "$var_val" ]; then
                            GS_DYNAMIC_FLAGS="${GS_DYNAMIC_FLAGS} --${flag} ${var_val}"
                        fi
                    fi
                done < <(grep '^GS_' "${CONFIG_DIR}/config")
            else
                log_info "WARN: User config error or missing. Using defaults."
            fi

            # --- 2. COMMAND ASSEMBLY & EXECUTION ---
            # -e: Steam integration, -f: Fullscreen.
            LAUNCH_CMD="gamescope -e -f ${GS_DYNAMIC_FLAGS} -- steam -gamepadui -steamos3"

            log_info "Executing: $LAUNCH_CMD"
            START_TIME=$(date +%s)
            eval "${LAUNCH_CMD}" >> "${LOG_FILE}" 2>&1

            # --- 3. EXIT & CRASH HANDLING ---
            DURATION=$(($(date +%s) - START_TIME))
            NEXT="desktop" # Default behavior after Steam exit is going to Desktop
            
            if [ $DURATION -lt 5 ]; then
                log_info "CRASH DETECTED: Steam ended too quickly ($DURATION s)."
                ssoth_banner "CRASH" "RECOVERING..."
                sleep 2
            fi

            # Atomic update of the next session file
            echo "$NEXT" > "${NEXT_SESSION_FILE}.tmp" && mv "${NEXT_SESSION_FILE}.tmp" "${NEXT_SESSION_FILE}"
            ;;

        "plasma"|"desktop")
            log_info "Launching Desktop Environment (Plasma)..."
            [ -f "${CONFIG_DIR}/config" ] && source "${CONFIG_DIR}/config"

            # Start Wayland session with SSOTH environment variables.
            env ${PLASMA_ENV} /usr/bin/startplasma-wayland >> "${LOG_FILE}" 2>&1

            # Atomic switch back to Steam for next boot.
            echo "steam" > "${NEXT_SESSION_FILE}.tmp" && mv "${NEXT_SESSION_FILE}.tmp" "${NEXT_SESSION_FILE}"
            ;;

        *)
            log_info "Unknown session: ${TARGET_SESSION}. Resetting to steam."
            echo "steam" > "${NEXT_SESSION_FILE}.tmp" && mv "${NEXT_SESSION_FILE}.tmp" "${NEXT_SESSION_FILE}"
            ;;
    esac

    # Prevent CPU hammering
    sleep "${CHECK_INTERVAL:-0.5}"
done
