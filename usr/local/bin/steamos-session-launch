#!/bin/bash
# =============================================================================
# SteamMachine-DIY - steamos-session-launch (v4.0.0)
# =============================================================================
set -uo pipefail

# --- 1. CARICAMENTO GERARCHICO ---
source "/etc/default/steamos-diy" 2>/dev/null || { echo "Master Config missing"; exit 1; }
[[ -f "${CONF_DIR}/config" ]] && source "${CONF_DIR}/config"

log() {
    local level=$1
    local msg=$2
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [SYS] [$level] $msg" >> "${LOG_FILE}" 2>/dev/null || true
    echo "[$level] $msg" | systemd-cat -t "steamos-diy"
}

# --- 2. HARDWARE DETECTION ---
DRM_PATH=$(dirname $(grep -l "^connected" /sys/class/drm/card*-*/status | head -n1) 2>/dev/null || echo "")
# Fallback sicuro ereditato dal Master
NATIVE_RES=$(head -n1 "$DRM_PATH/modes" 2>/dev/null || echo "${DEFAULT_RES}")

HW_W=${NATIVE_RES%x*}
HW_H=${NATIVE_RES#*x}

# Fallback se TARGET_WIDTH non è nel config utente
FINAL_W=${TARGET_WIDTH:-$HW_W}
FINAL_H=${TARGET_HEIGHT:-$HW_H}

# --- 3. GAMESCOPE SETUP ---
G_OPTS=("-e" "-W" "$FINAL_W" "-H" "$FINAL_H")

# Aggiungiamo i fallback :-0 per evitare errori 'unbound variable' con set -u
[[ "${ENABLE_MANGOAPP:-0}" == "1" ]] && G_OPTS+=("--mangoapp")
[[ "${ENABLE_HDR:-0}" == "1" ]]      && G_OPTS+=("--hdr-enabled")
[[ "${ENABLE_VRR:-0}" == "1" ]]      && G_OPTS+=("--adaptive-sync")
# REFRESH_RATE può essere vuota, quindi usiamo :-
[[ -n "${REFRESH_RATE:-}" ]]         && G_OPTS+=("-r" "$REFRESH_RATE")

if [[ -n "${GAMESCOPE_ARGS:-}" ]]; then
    read -r -a EXTRA_ARGS <<< "$GAMESCOPE_ARGS"
    G_OPTS+=("${EXTRA_ARGS[@]}")
fi

# --- 4. WATCHDOG & SIGNALS ---
cleanup_session() {
    log "EXIT" "Shutdown signal received. Cleaning up..."
    # Se G_PID non esiste ancora, evitiamo errori
    [[ -n "${G_PID:-}" ]] && kill -TERM "$G_PID" 2>/dev/null
    exit 0
}
trap cleanup_session SIGINT SIGTERM

# --- 5. EXECUTION LOOP ---
MAX_RETRIES=2
RETRY_COUNT=0

while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    if [ $RETRY_COUNT -eq 0 ]; then
        # Prende il comando completo dal Master
        CUR_STEAM="${STEAM_CMD}"
    else
        log "WARN" "Recovery mode: Using clean autoconfig."
        CUR_STEAM="steam -autoconfig" 
    fi

    log "LAUNCH" "Starting Gamescope: ${FINAL_W}x${FINAL_H} (Try: $((RETRY_COUNT + 1)))"
    START=$(date +%s)

    # Lancio pulito
    gamescope "${G_OPTS[@]}" -- env ${CUR_STEAM} >> "${LOG_FILE}" 2>&1 &
    G_PID=$!
    wait "$G_PID" || true

    if [ $(( $(date +%s) - START )) -lt 10 ]; then
        ((RETRY_COUNT++))
        log "WATCHDOG" "Crash detected. Attempt ${RETRY_COUNT}/${MAX_RETRIES}"
        sleep 2
    else
        log "EXIT" "Session ended normally."
        exit 0
    fi
done

# --- 6. FALLBACK ---
if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
    log "CRITICAL" "Max retries reached. Triggering OnFailure (Plasma)."
    exit 1
fi
