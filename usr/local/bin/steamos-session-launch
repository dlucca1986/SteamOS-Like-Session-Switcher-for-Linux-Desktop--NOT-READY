#!/bin/bash
# =============================================================================
# SteamMachine-DIY - Intelligent Universal Launcher
# =============================================================================
# Script: steamos-session-launch
# Version: 3.6.0
# Description: Minimal environment with ACTIVE recovery watchdog.
# Repository: https://github.com/dlucca1986/SteamMachine-DIY
# Path:         /usr/local/bin/steamos-session-launch
# License: MIT
# =============================================================================
set -eou pipefail

# --- 1. CONFIGURATION & AGNOSTIC ENVIRONMENT ---
GLOBAL_CONFIG="/etc/default/steamos-diy"
CURRENT_UID=$(id -u)
# Ensure D-Bus session bus is correctly mapped for the current user
export DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/${CURRENT_UID}/bus"

if [[ -f "$GLOBAL_CONFIG" ]]; then
    set -a
    source "$GLOBAL_CONFIG"
    set +a
else
    echo "[ERROR] Global configuration not found at $GLOBAL_CONFIG"
    exit 1
fi

# Set default log paths if not provided by global config
readonly LOG_FILE="${LOG_FILE:-/var/log/steamos-diy.log}"
readonly STEAM_LOG_PATH="${STEAM_LOG:-$HOME/.local/share/Steam/logs/console-linux.txt}"
readonly CONFIG_FILE="${CONF_DIR:-$HOME/.config/steamos-diy}/config"

# Logging function with timestamp and custom tags
log() {
    local tag="$1"
    local msg="$2"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ${LOG_TAG:-[SteamOS-DIY]} [$tag] $msg" >> "$LOG_FILE" 2>/dev/null || true
}

# --- GRACEFUL SHUTDOWN (SIGTERM) ---
# Handles cleanup when the service is stopped or interrupted
cleanup_session() {
    log "EXIT" "Termination signal received. Initiating graceful shutdown..."
    if [[ -n "${G_PID:-}" ]]; then
        kill -TERM "$G_PID" 2>/dev/null || true
    fi
    # Wait for gamescope to release the TTY/Display
    local timeout=3
    while [ $timeout -gt 0 ] && pgrep -x "gamescope" > /dev/null; do
        sleep 1
        ((timeout--))
    done
    log "EXIT" "All processes synchronized and closed. Session ended."
    exit 0
}

# Intercept termination signals
trap cleanup_session SIGINT SIGTERM

echo "========================================" >> "$LOG_FILE"
log "INIT" "New session initiated for user: $USER (UID: $CURRENT_UID)"

# --- 2. HARDWARE DETECTION ---
# Automatically detect the primary connected display and its native resolution
DRM_CONN=$(grep -l "^connected" /sys/class/drm/card*-*/status | head -n1 || true)
DRM_PATH=$(dirname "$DRM_CONN")
NATIVE_RES=$(head -n1 "$DRM_PATH/modes" 2>/dev/null || echo "1280x720")
HW_W=${NATIVE_RES%x*}
HW_H=${NATIVE_RES#*x}

# --- 3. LOCAL USER CONFIGURATION ---
# Source optional per-user configuration overrides
[[ -f "$CONFIG_FILE" ]] && source "$CONFIG_FILE"

# --- 4. DYNAMIC ARGUMENTS CONSTRUCTION & SAFETY CAP ---
G_OPTS=("${G_OPTS_BASE:--e}")
FINAL_W=${TARGET_WIDTH:-$HW_W}
FINAL_H=${TARGET_HEIGHT:-$HW_H}
FINAL_R=${REFRESH_RATE:-60}

# Safety Cap: Prevent requested resolution from exceeding hardware capabilities
if [ "$FINAL_W" -gt "$HW_W" ] || [ "$FINAL_H" -gt "$HW_H" ]; then
    log "WARN" "Requested ${FINAL_W}x${FINAL_H} exceeds hardware. Capping to native."
    FINAL_W=$HW_W; FINAL_H=$HW_H; FINAL_R=60
fi

G_OPTS+=("-W" "$FINAL_W" "-H" "$FINAL_H" "-r" "$FINAL_R")

# Feature Toggles (HDR, VRR, MangoHUD)
[[ "${ENABLE_HDR:-0}" == "1" ]] && G_OPTS+=("--hdr-enabled")
[[ "${ENABLE_VRR:-0}" == "1" ]] && G_OPTS+=("--adaptive-sync")
[[ "${ENABLE_MANGOAPP:-0}" == "1" ]] && G_OPTS+=("--mangoapp")

# Support for additional manual arguments passed via environment
if [[ -n "${GAMESCOPE_ARGS:-}" ]]; then
    read -r -a EXTRA <<< "$GAMESCOPE_ARGS"
    G_OPTS+=("${EXTRA[@]}")
fi

log "LAUNCH" "Gamescope OPTS: ${G_OPTS[*]}"

# --- 5. EXECUTION & WATCHDOG ---
START_TIME=$(date +%s)
G_EXIT_CODE=0

# Background execution with PID monitoring and line-buffered logging
stdbuf -oL -eL gamescope "${G_OPTS[@]}" -- \
    steam -steamdeck -steamos3 >> "$LOG_FILE" 2>&1 &

G_PID=$!

# Execute post-launch commands (e.g., VRR fixes or window management)
if [[ -n "${POST_LAUNCH_CMD:-}" ]]; then
    log "POST" "Scheduling post-launch command: $POST_LAUNCH_CMD"
    (sleep 5; eval "$POST_LAUNCH_CMD" >> "$LOG_FILE" 2>&1) &
fi

# Wait for the main gamescope process to terminate
wait "$G_PID" || G_EXIT_CODE=$?

RUNTIME=$(( $(date +%s) - START_TIME ))

# RECOVERY LOGIC: Detect early crashes (Watchdog)
if [ "$G_EXIT_CODE" -ne 0 ] && [ "$RUNTIME" -lt 10 ]; then
    log "CRITICAL" "Early crash detected after ${RUNTIME}s. RECOVERING..."

    # Force cleanup of any hung gamescope instances before recovery
    pgrep -x "gamescope" | xargs kill -9 2>/dev/null || true

    log "RECOVERY" "Launching Safe Mode at ${HW_W}x${HW_H}@60Hz"
    stdbuf -oL -eL gamescope -e -W "$HW_W" -H "$HW_H" -r 60 -- \
        steam -steamdeck -steamos3 >> "$LOG_FILE" 2>&1 || G_EXIT_CODE=$?
else
    log "EXIT" "Session finished naturally. Exit code: $G_EXIT_CODE"
fi

# --- 6. STEAM ERROR EXTRACTOR (SDY Marker) ---
# Extract diagnostic context from Steam logs if the session crashed
if [ "$G_EXIT_CODE" -ne 0 ]; then
    if [[ -f "$STEAM_LOG_PATH" ]]; then
        LAST_START_MARKER=$(grep -a "SDY_REATTIVO_START" "$STEAM_LOG_PATH" | tail -
